#!/bin/bash
# Daily PostgreSQL backup script for production.
# Stores compressed dumps locally; retains the last 30 days.
#
# Usage (on the server, via cron):
#   0 2 * * * /path/to/app/bin/backup
#
# Or via Kamal:
#   kamal app exec "bin/backup"

set -euo pipefail

BACKUP_DIR="${BACKUP_DIR:-/rails/storage/backups}"
RETENTION_DAYS="${RETENTION_DAYS:-30}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
FILENAME="bah_workshop_${TIMESTAMP}.sql.gz"

DB_HOST="${DATABASE_HOST:-localhost}"
DB_USER="${DATABASE_USERNAME:-postgres}"
DB_NAME="${RAILS_ENV:-production}"
DB_NAME="bah_workshop_${DB_NAME}"

mkdir -p "$BACKUP_DIR"

echo "[backup] Starting: ${FILENAME}"

PGPASSWORD="${DATABASE_PASSWORD}" pg_dump \
  -h "$DB_HOST" \
  -U "$DB_USER" \
  -Fc \
  --no-owner \
  --no-acl \
  "$DB_NAME" | gzip > "${BACKUP_DIR}/${FILENAME}"

echo "[backup] Created: ${BACKUP_DIR}/${FILENAME} ($(du -h "${BACKUP_DIR}/${FILENAME}" | cut -f1))"

# Prune old backups
DELETED=$(find "$BACKUP_DIR" -name "bah_workshop_*.sql.gz" -mtime +"$RETENTION_DAYS" -delete -print | wc -l)
if [ "$DELETED" -gt 0 ]; then
  echo "[backup] Pruned ${DELETED} backup(s) older than ${RETENTION_DAYS} days"
fi

echo "[backup] Done"
