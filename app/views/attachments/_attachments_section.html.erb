<%= turbo_frame_tag "attachments_section" do %>
  <div class="mt-8" data-controller="lightbox">
    <div class="flex items-center justify-between mb-4">
      <h2 class="section-title">
        <%= t("attachments.section_title") %>
        <span class="text-sm font-normal text-slate-500">
          (<%= related.attachments.kept.size %>)
        </span>
      </h2>
    </div>

    <% kept_attachments = related.attachments.kept.includes(:uploaded_by_user, file_attachment: :blob).order(created_at: :desc) %>

    <% if kept_attachments.any? %>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-6">
        <% kept_attachments.each_with_index do |attachment, index| %>
          <%= render "attachments/attachment_card", attachment: attachment, index: index %>
        <% end %>
      </div>
    <% else %>
      <div class="text-center py-8 mb-6 bg-slate-50/50 rounded-2xl border-2 border-dashed border-slate-200/50">
        <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909M3.75 21h16.5A2.25 2.25 0 0022.5 18.75V5.25A2.25 2.25 0 0020.25 3H3.75A2.25 2.25 0 001.5 5.25v13.5A2.25 2.25 0 003.75 21z" />
        </svg>
        <p class="mt-2 text-sm text-slate-500"><%= t("attachments.no_attachments") %></p>
      </div>
    <% end %>

    <% if policy(Attachment).create? %>
      <div data-controller="attachment-upload"
           data-attachment-upload-max-size-value="<%= Attachment::MAX_FILE_SIZE %>"
           data-attachment-upload-allowed-types-value="<%= Attachment::ALLOWED_CONTENT_TYPES.join(',') %>">

        <%= form_with url: attachments_path, method: :post, multipart: true,
              class: "relative",
              data: { attachment_upload_target: "form" } do |f| %>

          <%= f.hidden_field :related_type, value: related.class.name %>
          <%= f.hidden_field :related_id, value: related.id %>

          <div class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center transition-colors cursor-pointer
                      hover:border-indigo-400 hover:bg-indigo-50/30"
               data-attachment-upload-target="dropZone"
               data-action="dragover->attachment-upload#dragOver dragenter->attachment-upload#dragEnter dragleave->attachment-upload#dragLeave drop->attachment-upload#drop click->attachment-upload#triggerFileInput">

            <svg class="mx-auto h-10 w-10 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" />
            </svg>

            <p class="mt-2 text-sm text-slate-600">
              <span class="font-semibold text-indigo-600"><%= t("attachments.upload.choose_files") %></span>
              <%= t("attachments.upload.or_drag") %>
            </p>
            <p class="mt-1 text-xs text-slate-500"><%= t("attachments.upload.hint") %></p>

            <%= f.file_field :files, multiple: true,
                  class: "sr-only",
                  accept: Attachment::ALLOWED_CONTENT_TYPES.join(","),
                  data: { attachment_upload_target: "fileInput",
                          action: "change->attachment-upload#filesSelected" } %>
          </div>

          <%# Preview area for selected files %>
          <div data-attachment-upload-target="previewArea" class="hidden mt-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-medium text-slate-700" data-attachment-upload-target="fileCount"></h3>
              <button type="button"
                      class="text-sm text-red-600 hover:text-red-700"
                      data-action="click->attachment-upload#clearFiles">
                <%= t("attachments.upload.clear") %>
              </button>
            </div>
            <div data-attachment-upload-target="previewList"
                 class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
            </div>
            <div class="mt-4 flex justify-end">
              <%= f.submit t("attachments.upload.submit"),
                    class: "btn-primary disabled:opacity-50 disabled:cursor-not-allowed",
                    data: { attachment_upload_target: "submitButton" } %>
            </div>
          </div>
        <% end %>

        <%# Validation error toast %>
        <div data-attachment-upload-target="errorToast"
             class="hidden fixed bottom-4 right-4 z-50 max-w-sm bg-red-50/80 backdrop-blur-sm border border-red-200/50 rounded-xl p-4 shadow-lg">
          <div class="flex items-start gap-3">
            <svg class="h-5 w-5 text-red-500 mt-0.5 shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
            </svg>
            <p class="text-sm text-red-700" data-attachment-upload-target="errorMessage"></p>
          </div>
        </div>
      </div>
    <% end %>

    <%# Lightbox modal %>
    <div data-lightbox-target="modal"
         class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80"
         data-action="click->lightbox#close keydown.escape@window->lightbox#close">
      <button type="button"
              class="absolute top-4 right-4 text-white hover:text-slate-300 z-10"
              data-action="click->lightbox#close"
              aria-label="<%= t('common.close') %>">
        <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <button type="button"
              class="absolute left-4 top-1/2 -translate-y-1/2 text-white hover:text-slate-300 z-10"
              data-action="click->lightbox#prev"
              data-lightbox-target="prevBtn">
        <svg class="h-10 w-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>

      <button type="button"
              class="absolute right-4 top-1/2 -translate-y-1/2 text-white hover:text-slate-300 z-10"
              data-action="click->lightbox#next"
              data-lightbox-target="nextBtn">
        <svg class="h-10 w-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>

      <img data-lightbox-target="image"
           class="max-h-[90vh] max-w-[90vw] object-contain rounded-2xl shadow-2xl"
           src="" alt="" />
    </div>
  </div>
<% end %>
